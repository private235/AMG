<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø¨Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root {
--primary-color: #6C5CE7;
--secondary-color: #A29BFE;
--dark-color: #2D3436;
--light-color: #F5F6FA;
--accent-color: #00CE9F;
--danger-color: #E74C3C;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Tajawal', sans-serif;
}

body {
background-color: var(--light-color);
color: var(--dark-color);
padding: 20px;
}

.header {
text-align: center;
margin-bottom: 20px;
color: var(--primary-color);
font-size: 28px;
}

.filter-panel {
background-color: white;
padding: 15px;
border-radius: 10px;
box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
margin-bottom: 20px;
max-width: 1400px;
margin-left: auto;
margin-right: auto;
}

.form-select {
padding: 10px;
border: 1px solid #ddd;
border-radius: 8px;
font-size: 16px;
width: 300px;
max-width: 100%;
}

.main-content {
display: flex;
gap: 20px;
min-height: 70vh;
max-width: 1400px;
margin: 0 auto;
}

.lecture-list-panel {
flex: 1;
background-color: #f0f0f5;
padding: 15px;
border-radius: 10px;
box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
overflow-y: auto;
min-width: 300px;
max-height: 85vh;
}

.panel-title {
font-size: 18px;
font-weight: 700;
color: var(--dark-color);
margin-bottom: 15px;
border-bottom: 2px solid var(--secondary-color);
padding-bottom: 5px;
}

.months-container {
flex: 3;
display: grid;
grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
gap: 20px;
}

.month-column {
background-color: white;
padding: 15px;
border-radius: 10px;
box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
min-height: 200px;
border: 2px dashed transparent;
transition: background-color 0.2s, border-color 0.2s;
}

.drag-over {
background-color: #e6e0ff !important;
border-color: var(--primary-color) !important;
}

.lecture-item {
background-color: #fff;
padding: 10px;
border-radius: 6px;
margin-bottom: 8px;
cursor: grab;
box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
font-size: 14px;
font-weight: 500;
border-right: 4px solid var(--accent-color);
transition: opacity 0.2s;
}

.is-dragging {
opacity: 0.4;
border-color: var(--primary-color);
border-style: solid;
}

.empty-state {
text-align: center;
color: #999;
padding: 20px 0;
font-size: 14px;
}

.loading-spinner {
border: 4px solid rgba(0, 0, 0, 0.1);
border-top: 4px solid var(--primary-color);
border-radius: 50%;
width: 20px;
height: 20px;
animation: spin 1s linear infinite;
display: inline-block;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

.alert {
padding: 10px;
border-radius: 8px;
margin-bottom: 15px;
font-weight: 500;
text-align: center;
}

.alert-success {
background-color: #d4edda;
color: #155724;
}

.alert-danger {
background-color: #f8d7da;
color: #721c24;
}
</style>
</head>
<body>

<h2 class="header">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø¨Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ø¨ÙŠÙ† Ø§Ù„Ø´Ù‡ÙˆØ±</h2>
<div id="alert-message"></div>

<div class="filter-panel">
<label for="year-selector" style="font-weight: 700; display: block; margin-bottom: 5px;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</label>
<select id="year-selector" class="form-select">
<option value="" disabled selected>--- Ø§Ø®ØªØ± Ù…Ø±Ø­Ù„Ø© ---</option>
<!-- Populated by JS -->
</select>
</div>

<div class="main-content">

<div class="lecture-list-panel" id="uncategorized-container">
<div class="panel-title">Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ØµÙ†ÙØ©</div>
<div id="uncategorized-lectures" class="month-column" data-month-id="uncategorized">
<div class="empty-state">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø±Ø­Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹...</div>
</div>
</div>

<div class="months-container" id="months-container">
<div class="empty-state">
<p>Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡ÙˆØ± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©.</p>
</div>
</div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: 'AIzaSyCdqYrVFspJ4rZwidfaPtc9PYpNlQQm09k',
    appId: '1:284879336757:web:1f42836c2382d11b73087c',
    messagingSenderId: '284879336757',
    projectId: 'amgg-81ac3',
    authDomain: 'amgg-81ac3.firebaseapp.com',
    databaseURL: 'https://amgg-81ac3-default-rtdb.firebaseio.com',
    storageBucket: 'amgg-81ac3.firebasestorage.app',
};

if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

const database = firebase.database();
const monthsRef = database.ref('months');
const lecturesRef = database.ref('lecturess');

const yearSelector = document.getElementById('year-selector');
const monthsContainer = document.getElementById('months-container');
const uncategorizedContainer = document.getElementById('uncategorized-lectures');
const alertMessageDiv = document.getElementById('alert-message');

let currentYearKey = null;
let allMonthsData = {};
let allLecturesData = {};

// **Ø§Ù„ØªØ¹Ø¯ÙŠÙ„**: ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ØµØ­ÙŠØ­Ø©
for (let i = 1; i <= 25; i++) {
    const teacherName = `Ù…Ø¯Ø±Ø³ ${i}`;
    const option = document.createElement('option');
    option.value = teacherName; // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙŠ ØªÙØ³ØªØ®Ø¯Ù… Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    option.textContent = teacherName; // Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ ÙŠØ±Ø§Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    yearSelector.appendChild(option);
}

function showAlert(message, type = 'success') {
    alertMessageDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    setTimeout(() => {
        alertMessageDiv.innerHTML = '';
    }, 5000);
}

async function fetchDataAndRender() {
    currentYearKey = yearSelector.value;
    if (!currentYearKey) return;

    monthsContainer.innerHTML = `<div class="empty-state"><span class="loading-spinner"></span> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>`;
    uncategorizedContainer.innerHTML = `<div class="empty-state"><span class="loading-spinner"></span></div>`;

    try {
        const monthSnapshot = await monthsRef.child(currentYearKey).once('value');
        const rawMonths = monthSnapshot.val() || {};
        
        const lectureSnapshot = await lecturesRef.child(currentYearKey).once('value');
        allLecturesData = lectureSnapshot.val() || {};

        allMonthsData = Object.entries(rawMonths).map(([id, data]) => ({ id, ...data }));
        allMonthsData.sort((a, b) => (a.order || 999) - (b.order || 999));

        renderUI();

    } catch (error) {
        console.error("Error fetching data:", error);
        showAlert(`ğŸš« ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`, 'danger');
        monthsContainer.innerHTML = `<div class="empty-state" style="color: var(--danger-color);">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</div>`;
    }
}

function renderUI() {
    // Render Month Columns
    if (allMonthsData.length === 0) {
        monthsContainer.innerHTML = `<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ù‡ÙˆØ±/ÙˆØ­Ø¯Ø§Øª Ù…ÙØ¶Ø§ÙØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø©.</div>`;
    } else {
        monthsContainer.innerHTML = allMonthsData.map(month => `
            <div class="month-column" data-month-id="${month.id}">
                <div class="panel-title">${month.name || 'Ø´Ù‡Ø± ØºÙŠØ± Ù…Ø³Ù…Ù‰'}</div>
                <div id="month-${month.id}-lectures"></div>
            </div>
        `).join('');
    }

    // Render Lectures
    uncategorizedContainer.innerHTML = '';
    document.querySelectorAll('.month-column > div[id]').forEach(div => div.innerHTML = '');

    let hasUncategorizedLectures = false;
    
    Object.entries(allLecturesData).forEach(([key, value]) => {
        // Check if the key is a month ID
        const isMonthNode = allMonthsData.some(m => m.id === key);

        if (isMonthNode) { // It's a month node containing lectures
            const monthId = key;
            const lecturesInMonth = value;
            const container = document.getElementById(`month-${monthId}-lectures`);
            if (container) {
                Object.entries(lecturesInMonth).forEach(([lectureId, lectureData]) => {
                    container.innerHTML += createLectureItem(lectureId, lectureData, monthId);
                });
            }
        } else if (value && value.title) { // It's an uncategorized lecture
            const lectureId = key;
            const lectureData = value;
            uncategorizedContainer.innerHTML += createLectureItem(lectureId, lectureData, 'uncategorized');
            hasUncategorizedLectures = true;
        }
    });

    if (!hasUncategorizedLectures) {
        uncategorizedContainer.innerHTML = `<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª ØºÙŠØ± Ù…ØµÙ†ÙØ©.</div>`;
    }

    // Add drag-drop event listeners to all columns (including uncategorized)
    document.querySelectorAll('.month-column').forEach(column => {
        column.addEventListener('dragover', handleDragOver);
        column.addEventListener('dragleave', handleDragLeave);
        column.addEventListener('drop', handleDrop);
    });
}


function createLectureItem(id, data, parentMonthId) {
    return `
    <div class="lecture-item" 
         draggable="true" 
         data-lecture-id="${id}" 
         data-current-month-id="${parentMonthId}"
         data-lecture-title="${data.title || 'Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}">
        ${data.lectureNumber || ''}. ${data.title || 'Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}
    </div>
    `;
}

// ==========================================================
// ========== Drag and Drop Logic ==========
// ==========================================================
let draggedLecture = null;

document.addEventListener('dragstart', (e) => {
    if (e.target.classList.contains('lecture-item')) {
        draggedLecture = e.target;
        e.dataTransfer.setData('text/plain', e.target.dataset.lectureId);
        setTimeout(() => e.target.classList.add('is-dragging'), 0);
    }
});

document.addEventListener('dragend', (e) => {
    if (draggedLecture) {
        draggedLecture.classList.remove('is-dragging');
        draggedLecture = null;
    }
});

function handleDragOver(e) {
    e.preventDefault();
    const dropTarget = e.target.closest('.month-column');
    if (dropTarget) {
        dropTarget.classList.add('drag-over');
    }
}

function handleDragLeave(e) {
    const dropTarget = e.target.closest('.month-column');
    if (dropTarget) {
        dropTarget.classList.remove('drag-over');
    }
}

async function handleDrop(e) {
    e.preventDefault();
    const dropTarget = e.target.closest('.month-column');
    if (!dropTarget || !draggedLecture) return;

    dropTarget.classList.remove('drag-over');

    const newMonthId = dropTarget.dataset.monthId;
    const lectureId = draggedLecture.dataset.lectureId;
    const oldMonthId = draggedLecture.dataset.currentMonthId;
    const lectureTitle = draggedLecture.dataset.lectureTitle;

    if (oldMonthId === newMonthId) return;

    // Move element in UI first for instant feedback
    const targetLectureContainer = dropTarget.querySelector('div[id]') || dropTarget;
    targetLectureContainer.appendChild(draggedLecture);

    // Update Firebase
    await updateLectureLocation(lectureId, oldMonthId, newMonthId, lectureTitle);
}

async function updateLectureLocation(lectureId, oldMonthId, newMonthId, lectureTitle) {
    if (!currentYearKey) return;

    const oldPath = (oldMonthId === 'uncategorized') 
        ? `lecturess/${currentYearKey}/${lectureId}` 
        : `lecturess/${currentYearKey}/${oldMonthId}/${lectureId}`;
        
    const newPath = (newMonthId === 'uncategorized')
        ? `lecturess/${currentYearKey}/${lectureId}` 
        : `lecturess/${currentYearKey}/${newMonthId}/${lectureId}`;

    showAlert(`Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© "${lectureTitle}"...`, 'success');

    try {
        const snapshot = await database.ref(oldPath).once('value');
        const lectureData = snapshot.val();

        if (!lectureData) {
            throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.');
        }
        
        // Add/update month property in the data being moved
        lectureData.month = newMonthId;

        const updates = {};
        updates[newPath] = lectureData;
        updates[oldPath] = null; // Delete old location

        await database.ref().update(updates);

        showAlert(`âœ… ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© "${lectureTitle}" Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
        
        // Refresh data to ensure consistency
        fetchDataAndRender();

    } catch (error) {
        console.error('Firebase Update Error:', error);
        showAlert(`ğŸš« ÙØ´Ù„ Ø§Ù„Ù†Ù‚Ù„: ${error.message}.`, 'danger');
        // Re-render to revert UI change on failure
        fetchDataAndRender();
    }
}

yearSelector.addEventListener('change', fetchDataAndRender);

</script>
</body>
</html>
