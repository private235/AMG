<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø¨Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root {
--primary-color: #6C5CE7;
--secondary-color: #A29BFE;
--dark-color: #2D3436;
--light-color: #F5F6FA;
--accent-color: #00CE9F;
--danger-color: #E74C3C;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Tajawal', sans-serif;
}

body {
background-color: var(--light-color);
color: var(--dark-color);
padding: 20px;
}

.header {
text-align: center;
margin-bottom: 20px;
color: var(--primary-color);
font-size: 28px;
}

.filter-panel {
background-color: white;
padding: 15px;
border-radius: 10px;
box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
margin-bottom: 20px;
}

.form-select {
padding: 10px;
border: 1px solid #ddd;
border-radius: 8px;
font-size: 16px;
width: 300px;
max-width: 100%;
}

.main-content {
display: flex;
gap: 20px;
min-height: 70vh;
max-width: 1400px;
margin: 0 auto;
}

.lecture-list-panel {
flex: 1;
background-color: #f0f0f5;
padding: 15px;
border-radius: 10px;
box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
overflow-y: auto;
min-width: 300px;
max-height: 85vh;
}

.panel-title {
font-size: 18px;
font-weight: 700;
color: var(--dark-color);
margin-bottom: 15px;
border-bottom: 2px solid var(--secondary-color);
padding-bottom: 5px;
}

.months-container {
flex: 3;
display: grid;
grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
gap: 20px;
}

.month-column {
background-color: white;
padding: 15px;
border-radius: 10px;
box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
min-height: 200px;
border: 2px dashed transparent;
transition: background-color 0.2s, border-color 0.2s;
}

.drag-over {
background-color: #e6e0ff !important;
border-color: var(--primary-color) !important;
}

.lecture-item {
background-color: #fff;
padding: 10px;
border-radius: 6px;
margin-bottom: 8px;
cursor: grab;
box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
font-size: 14px;
font-weight: 500;
border-right: 4px solid var(--accent-color);
transition: opacity 0.2s;
}

.is-dragging {
opacity: 0.4;
border-color: var(--primary-color);
border-style: solid;
}

.empty-state {
text-align: center;
color: #999;
padding: 20px 0;
font-size: 14px;
}

.loading-spinner {
border: 4px solid rgba(0, 0, 0, 0.1);
border-top: 4px solid var(--primary-color);
border-radius: 50%;
width: 20px;
height: 20px;
animation: spin 1s linear infinite;
display: inline-block;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

.alert {
padding: 10px;
border-radius: 8px;
margin-bottom: 15px;
font-weight: 500;
text-align: center;
}

.alert-success {
background-color: #d4edda;
color: #155724;
}

.alert-danger {
background-color: #f8d7da;
color: #721c24;
}
</style>
</head>
<body>

<h2 class="header">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø¨Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ø¨ÙŠÙ† Ø§Ù„Ø´Ù‡ÙˆØ±</h2>
<div id="alert-message"></div>

<div class="filter-panel">
<label for="year-selector" style="font-weight: 700; display: block; margin-bottom: 5px;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</label>
<select id="year-selector" class="form-select">
<option value="" disabled selected>--- Ø§Ø®ØªØ± Ù…Ø±Ø­Ù„Ø© ---</option>
<option value="teacher_1">Ù…Ø¯Ø±Ø³ 1</option>
<option value="teacher_2">Ù…Ø¯Ø±Ø³ 2</option>
<option value="teacher_3">Ù…Ø¯Ø±Ø³ 3</option>
<option value="teacher_4">Ù…Ø¯Ø±Ø³ 4</option>
<option value="teacher_5">Ù…Ø¯Ø±Ø³ 5</option>
<option value="teacher_6">Ù…Ø¯Ø±Ø³ 6</option>
<option value="teacher_7">Ù…Ø¯Ø±Ø³ 7</option>
<option value="teacher_8">Ù…Ø¯Ø±Ø³ 8</option>
<option value="teacher_9">Ù…Ø¯Ø±Ø³ 9</option>
<option value="teacher_10">Ù…Ø¯Ø±Ø³ 10</option>
<option value="teacher_11">Ù…Ø¯Ø±Ø³ 11</option>
<option value="teacher_12">Ù…Ø¯Ø±Ø³ 12</option>
<option value="teacher_13">Ù…Ø¯Ø±Ø³ 13</option>
<option value="teacher_14">Ù…Ø¯Ø±Ø³ 14</option>
<option value="teacher_15">Ù…Ø¯Ø±Ø³ 15</option>
<option value="teacher_16">Ù…Ø¯Ø±Ø³ 16</option>
<option value="teacher_17">Ù…Ø¯Ø±Ø³ 17</option>
<option value="teacher_18">Ù…Ø¯Ø±Ø³ 18</option>
<option value="teacher_19">Ù…Ø¯Ø±Ø³ 19</option>
<option value="teacher_20">Ù…Ø¯Ø±Ø³ 20</option>
<option value="teacher_21">Ù…Ø¯Ø±Ø³ 21</option>
<option value="teacher_22">Ù…Ø¯Ø±Ø³ 22</option>
<option value="teacher_23">Ù…Ø¯Ø±Ø³ 23</option>
<option value="teacher_24">Ù…Ø¯Ø±Ø³ 24</option>
<option value="teacher_25">Ù…Ø¯Ø±Ø³ 25</option>
</select>
</div>

<div class="main-content">

<div class="lecture-list-panel" id="uncategorized-container">
<div class="panel-title">Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ØµÙ†ÙØ©</div>
<div id="uncategorized-lectures" class="month-column" data-month-id="uncategorized">
<div class="empty-state">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø±Ø­Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹...</div>
</div>
</div>

<div class="months-container" id="months-container">
<div class="empty-state">
<p>Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡ÙˆØ± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©.</p>
</div>
</div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
apiKey: 'AIzaSyCdqYrVFspJ4rZwidfaPtc9PYpNlQQm09k',
appId: '1:284879336757:web:1f42836c2382d11b73087c',
messagingSenderId: '284879336757',
projectId: 'amgg-81ac3',
authDomain: 'amgg-81ac3.firebaseapp.com',
databaseURL: 'https://amgg-81ac3-default-rtdb.firebaseio.com',
storageBucket: 'amgg-81ac3.firebasestorage.app',
};

if (!firebase.apps.length) {
firebase.initializeApp(firebaseConfig);
}

const database = firebase.database();
const monthsRef = database.ref('months');
const lecturesRef = database.ref('lecturess');

const yearSelector = document.getElementById('year-selector');
const monthsContainer = document.getElementById('months-container');
const uncategorizedContainer = document.getElementById('uncategorized-lectures');
const alertMessageDiv = document.getElementById('alert-message');

let currentYearKey = null;
let allMonthsData = {};
let allLecturesData = {};

const yearKeysDisplayMap = {
'first': 'Ø£ÙˆÙ„Ù‰',
'second_chemistry': 'Ø«Ø§Ù†ÙŠØ© ÙƒÙŠÙ…ÙŠØ§Ø¡',
'second_physics': 'Ø«Ø§Ù†ÙŠØ© ÙÙŠØ²ÙŠØ§Ø¡',
'third': 'Ø«Ø§Ù„Ø«Ø©'
};
const yearDisplayNames = {};
const yearKeysMap = {};

for (let i = 1; i <= 25; i++) {
const key = `teacher_${i}`;
const displayName = `Ù…Ø¯Ø±Ø³ ${i}`;
yearDisplayNames[key] = displayName;
yearKeysMap[displayName] = key;
}

function showAlert(message, type = 'success') {
alertMessageDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
setTimeout(() => {
alertMessageDiv.innerHTML = '';
}, 5000);
}

// ==========================================================
// ========== ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ù‡ÙˆØ± (Ø§Ù„Ø¥Ø¶Ø§ÙØ©) ==========
// ==========================================================

const addMonthBtn = document.getElementById('add-month-btn');
const newMonthYearSelect = document.getElementById('new-month-year');
const newMonthNameInput = document.getElementById('new-month-name');
const newMonthOrderInput = document.getElementById('new-month-order');

async function addMonth() {
const yearKey = newMonthYearSelect.value;
const monthName = newMonthNameInput.value.trim();
const order = parseInt(newMonthOrderInput.value) || 999;

if (!yearKey || !monthName) {
showAlert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ù†Ø© ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø±.', 'danger');
return;
}

addMonthBtn.disabled = true;
addMonthBtn.innerHTML = '<span class="loading-spinner" style="width: 16px; height: 16px;"></span>';

try {
const newMonthRef = monthsRef.child(yearKey).push();

await newMonthRef.set({
name: monthName,
order: order,
createdAt: firebase.database.ServerValue.TIMESTAMP
});

showAlert(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ù‡Ø±/Ø§Ù„ÙˆØ­Ø¯Ø©: "${monthName}" Ù„Ø³Ù†Ø© ${yearDisplayNames[yearKey]} Ø¨Ù†Ø¬Ø§Ø­.`, 'success');

await fetchAllMonths();

newMonthNameInput.value = '';
newMonthOrderInput.value = (order + 1).toString();

} catch (error) {
console.error("Error adding month:", error);
showAlert(`ğŸš« ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ù‡Ø±: ${error.message}`, 'danger');
} finally {
addMonthBtn.disabled = false;
addMonthBtn.innerHTML = 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ù‡Ø±';
}
}

addMonthBtn.addEventListener('click', addMonth);


// ==========================================================
// ========== ÙˆØ¸Ø§Ø¦Ù Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ==========
// ==========================================================

async function fetchAllMonths() {
try {
const snapshot = await monthsRef.once('value');
allMonthsData = snapshot.val() || {};
} catch (error) {
console.error("Error fetching all months:", error);
}
}

async function fetchDataAndRender() {
currentYearKey = yearSelector.value;
if (!currentYearKey) return;

monthsContainer.innerHTML = `<div class="empty-state"><span class="loading-spinner"></span> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡ÙˆØ± ÙˆØ§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª...</div>`;
uncategorizedContainer.innerHTML = `<div class="empty-state">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ØµÙ†ÙØ©...</div>`;

try {
const monthSnapshot = await monthsRef.child(currentYearKey).once('value');
const rawMonths = monthSnapshot.val() || {};
Â  Â  Â  Â  Â  Â  Â  Â  
const lectureSnapshot = await lecturesRef.child(currentYearKey).once('value');
allLecturesData = lectureSnapshot.val() || {};

allMonthsData = Object.entries(rawMonths).map(([id, data]) => ({ id, ...data }));
allMonthsData.sort((a, b) => (a.order || 999) - (b.order || 999));

renderMonths();
renderLectures();

} catch (error) {
console.error("Error fetching data:", error);
showAlert(`ğŸš« ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`, 'danger');
monthsContainer.innerHTML = `<div class="empty-state" style="color: var(--danger-color);">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</div>`;
}
}

function renderMonths() {
if (allMonthsData.length === 0) {
monthsContainer.innerHTML = `<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ù‡ÙˆØ±/ÙˆØ­Ø¯Ø§Øª Ù…ÙØ¶Ø§ÙØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø©.</div>`;
return;
}

monthsContainer.innerHTML = allMonthsData.map(month => `
<div class="month-column" data-month-id="${month.id}">
<div class="panel-title">${month.name || 'Ø´Ù‡Ø± ØºÙŠØ± Ù…Ø³Ù…Ù‰'} (ØªØ±ØªÙŠØ¨: ${month.order || '?'})</div>
<div id="month-${month.id}-lectures">
</div>
</div>
`).join('');

document.querySelectorAll('.month-column').forEach(column => {
column.addEventListener('dragover', handleDragOver);
column.addEventListener('dragleave', handleDragLeave);
column.addEventListener('drop', handleDrop);
});
}

function renderLectures() {
document.querySelectorAll('.month-column > div').forEach(div => {
if (!div.id.includes('uncategorized')) div.innerHTML = '';
});
uncategorizedContainer.innerHTML = '';

let hasLectures = false;

Object.entries(allLecturesData).forEach(([monthIdOrLectureId, data]) => {
if (typeof data !== 'object' || data === null) return;

const isMonthContainer = allMonthsData.some(m => m.id === monthIdOrLectureId);

if (isMonthContainer) {
const lecturesInMonth = data;
const container = document.getElementById(`month-${monthIdOrLectureId}-lectures`);

if (container) {
const lectureList = Object.entries(lecturesInMonth)
.map(([lectureId, lectureData]) => ({ lectureId, ...lectureData }))
.sort((a, b) => (a.order || 999) - (b.order || 999));

container.innerHTML = lectureList.map(lec => createLectureItem(lec.lectureId, lec, monthIdOrLectureId)).join('');
if (lectureList.length > 0) hasLectures = true;
}
} else {
const lectureId = monthIdOrLectureId;
const lectureData = data;

if (!lectureData.title) return;

uncategorizedContainer.innerHTML += createLectureItem(lectureId, lectureData, 'uncategorized');
hasLectures = true;
}
});

if (!hasLectures) {
uncategorizedContainer.innerHTML = `<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©.</div>`;
} else if (uncategorizedContainer.innerHTML === '') {
uncategorizedContainer.innerHTML = `<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª ØºÙŠØ± Ù…ØµÙ†ÙØ©.</div>`;
}
}

function createLectureItem(id, data, parentMonthId) {
return `
<div class="lecture-item" 
draggable="true" 
data-lecture-id="${id}" 
data-current-month-id="${parentMonthId}"
data-lecture-title="${data.title || 'Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}">
${data.title || 'Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'} (#${data.order || '?'})
</div>
`;
}

// ==========================================================
// ========== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª (Drag and Drop) ==========
// ==========================================================

let draggedLecture = null;

document.addEventListener('dragstart', (e) => {
if (e.target.classList.contains('lecture-item')) {
draggedLecture = e.target;
e.dataTransfer.setData('text/plain', e.target.dataset.lectureId);
e.target.classList.add('is-dragging');
}
});

document.addEventListener('dragend', (e) => {
if (e.target === draggedLecture) {
e.target.classList.remove('is-dragging');
draggedLecture = null;
}
});

function handleDragOver(e) {
e.preventDefault();
if (e.target.classList.contains('month-column')) {
e.target.classList.add('drag-over');
} else if (e.target.closest('.month-column')) {
e.target.closest('.month-column').classList.add('drag-over');
}
}

function handleDragLeave(e) {
if (e.target.classList.contains('month-column')) {
e.target.classList.remove('drag-over');
} else if (e.target.closest('.month-column')) {
e.target.closest('.month-column').classList.remove('drag-over');
}
}

async function handleDrop(e) {
e.preventDefault();

let dropTarget = e.target.closest('.month-column');
if (!dropTarget) return; 

dropTarget.classList.remove('drag-over');

const newMonthId = dropTarget.dataset.monthId;
const lectureId = e.dataTransfer.getData('text/plain');

if (!lectureId || !draggedLecture) {
showAlert('Ø®Ø·Ø£ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©.', 'danger');
return;
}

const oldMonthId = draggedLecture.dataset.currentMonthId;
const lectureTitle = draggedLecture.dataset.lectureTitle;

if (oldMonthId === newMonthId) {
showAlert('Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.', 'danger');
return;
}

const targetContainer = dropTarget.querySelector(`#month-${newMonthId}-lectures`) || dropTarget;
targetContainer.appendChild(draggedLecture);
draggedLecture.dataset.currentMonthId = newMonthId;

await updateLectureLocation(lectureId, oldMonthId, newMonthId, lectureTitle);
}

async function updateLectureLocation(lectureId, oldMonthId, newMonthId, lectureTitle) {
if (!currentYearKey) return;

const isMovingFromUncategorized = oldMonthId === 'uncategorized';
const isMovingToUncategorized = newMonthId === 'uncategorized';

const oldPath = isMovingFromUncategorized 
? `${currentYearKey}/${lectureId}` 
: `${currentYearKey}/${oldMonthId}/${lectureId}`;
Â  Â  Â  Â  Â  Â  
const newPath = isMovingToUncategorized
? `${currentYearKey}/${lectureId}` 
: `${currentYearKey}/${newMonthId}/${lectureId}`;

showAlert(`Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© "${lectureTitle}"...`, 'success');

try {
const snapshot = await lecturesRef.child(oldPath).once('value');
const lectureData = snapshot.val();

if (!lectureData) {
throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.');
}

await lecturesRef.child(newPath).set(lectureData);
await lecturesRef.child(oldPath).remove();

showAlert(`âœ… ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© "${lectureTitle}" Ø¨Ù†Ø¬Ø§Ø­!`, 'success');

fetchDataAndRender();

} catch (error) {
console.error('Firebase Update Error:', error);
showAlert(`ğŸš« ÙØ´Ù„ Ø§Ù„Ù†Ù‚Ù„: ${error.message}. (ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø§Ù„Ù†Ù‚Ù„ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Firebase)`, 'danger');
}
}

yearSelector.addEventListener('change', fetchDataAndRender);

fetchDataAndRender();
</script>
</body>
</html>