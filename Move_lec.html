<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إدارة المحاضرات بالسحب والإفلات</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root {
--primary-color: #6C5CE7;
--secondary-color: #A29BFE;
--dark-color: #2D3436;
--light-color: #F5F6FA;
--accent-color: #00CE9F;
--danger-color: #E74C3C;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Tajawal', sans-serif;
}

body {
background-color: var(--light-color);
color: var(--dark-color);
padding: 20px;
}

/* [تعديل] إخفاء محتوى الصفحة افتراضياً */
#page-content {
    display: none;
}

.header {
text-align: center;
margin-bottom: 20px;
color: var(--primary-color);
font-size: 28px;
}

.filter-panel {
background-color: white;
padding: 15px;
border-radius: 10px;
box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
margin-bottom: 20px;
max-width: 1400px;
margin-left: auto;
margin-right: auto;
}

.form-select {
padding: 10px;
border: 1px solid #ddd;
border-radius: 8px;
font-size: 16px;
width: 300px;
max-width: 100%;
}

.main-content {
display: flex;
gap: 20px;
min-height: 70vh;
max-width: 1400px;
margin: 0 auto;
}

.lecture-list-panel {
flex: 1;
background-color: #f0f0f5;
padding: 15px;
border-radius: 10px;
box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
overflow-y: auto;
min-width: 300px;
max-height: 85vh;
}

.panel-title {
font-size: 18px;
font-weight: 700;
color: var(--dark-color);
margin-bottom: 15px;
border-bottom: 2px solid var(--secondary-color);
padding-bottom: 5px;
}

.months-container {
flex: 3;
display: grid;
grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
gap: 20px;
}

.month-column {
background-color: white;
padding: 15px;
border-radius: 10px;
box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
min-height: 200px;
border: 2px dashed transparent;
transition: background-color 0.2s, border-color 0.2s;
}

.drag-over {
background-color: #e6e0ff !important;
border-color: var(--primary-color) !important;
}

.lecture-item {
background-color: #fff;
padding: 10px;
border-radius: 6px;
margin-bottom: 8px;
cursor: grab;
box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
font-size: 14px;
font-weight: 500;
border-right: 4px solid var(--accent-color);
transition: opacity 0.2s;
}

.is-dragging {
opacity: 0.4;
border-color: var(--primary-color);
border-style: solid;
}

.empty-state {
text-align: center;
color: #999;
padding: 20px 0;
font-size: 14px;
}

.loading-spinner {
border: 4px solid rgba(0, 0, 0, 0.1);
border-top: 4px solid var(--primary-color);
border-radius: 50%;
width: 20px;
height: 20px;
animation: spin 1s linear infinite;
display: inline-block;
margin-left: 5px; /* Add some space */
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

.alert {
padding: 12px 15px; /* Adjusted padding */
border-radius: 8px;
margin-bottom: 15px;
font-weight: 500;
text-align: center;
max-width: 1400px; /* Match content width */
margin-left: auto;
margin-right: auto;
}

.alert-success {
background-color: #d1fae5; /* Tailwind green-100 */
color: #065f46; /* Tailwind green-800 */
border: 1px solid #6ee7b7; /* Tailwind green-300 */
}

.alert-danger {
background-color: #fee2e2; /* Tailwind red-100 */
color: #991b1b; /* Tailwind red-800 */
border: 1px solid #fca5a5; /* Tailwind red-300 */
}
</style>
</head>
<body>
<!-- [تعديل] تغليف المحتوى الرئيسي -->
<div id="page-content">
    <h2 class="header">إدارة المحاضرات بالسحب والإفلات بين الشهور</h2>
    <div id="alert-message"></div>

    <div class="filter-panel">
    <label for="year-selector" style="font-weight: 700; display: block; margin-bottom: 5px;">اختر المدرس/السنة:</label>
    <select id="year-selector" class="form-select">
    <option value="" disabled selected>--- اختر ---</option>
    <!-- Populated by JS -->
    </select>
    </div>

    <div class="main-content">

    <div class="lecture-list-panel" id="uncategorized-container">
    <div class="panel-title">المحاضرات غير المصنفة</div>
    <div id="uncategorized-lectures" class="month-column" data-month-id="_uncategorized_"> <!-- Consistent ID -->
    <div class="empty-state">الرجاء اختيار مدرس/سنة أولاً...</div>
    </div>
    </div>

    <div class="months-container" id="months-container">
    <div class="empty-state">
    <p>سيتم عرض الشهور هنا بعد اختيار المدرس/السنة.</p>
    </div>
    </div>

    </div>
</div> <!-- End #page-content -->

<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<!-- [تعديل] إضافة Auth SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>

<script>
// ==========================================================
// Firebase Config
// ==========================================================
const firebaseConfig = {
    apiKey: 'AIzaSyCdqYrVFspJ4rZwidfaPtc9PYpNlQQm09k',
    appId: '1:284879336757:web:1f42836c2382d11b73087c',
    messagingSenderId: '284879336757',
    projectId: 'amgg-81ac3',
    authDomain: 'amgg-81ac3.firebaseapp.com',
    databaseURL: 'https://amgg-81ac3-default-rtdb.firebaseio.com',
    storageBucket: 'amgg-81ac3.firebasestorage.app',
};
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
// ==========================================================
// Admin Guard
// ==========================================================
const auth = firebase.auth();
const database = firebase.database(); // Define globally

 // Global function for showing alerts, usable by guard too
 function showGlobalAlert(message, type = 'danger', autoClear = true) {
     const alertDiv = document.getElementById('alert-message');
     if (alertDiv) {
         alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
         if (autoClear) {
             setTimeout(() => { if (alertDiv) alertDiv.innerHTML = ''; }, 5000);
         }
     } else {
         alert(message); // Fallback
     }
 }


auth.onAuthStateChanged(user => {
    if (user) {
        database.ref(`admins/${user.uid}`).once('value', snapshot => {
            if (snapshot.exists()) {
                console.log('Admin access granted.');
                document.getElementById('page-content').style.display = 'block'; // Show content
                initializeAppLogic(); // Initialize the main logic
            } else {
                 showGlobalAlert('ليس لديك صلاحيات الوصول لهذه الصفحة.', 'danger', false);
                 setTimeout(() => {
                     auth.signOut();
                     window.location.href = 'index.html'; // Redirect to login
                 }, 3000);
            }
        }).catch(error => {
             console.error("Error checking admin status:", error);
             showGlobalAlert('خطأ في التحقق من صلاحيات الأدمن.', 'danger', false);
              setTimeout(() => { window.location.href = 'index.html'; }, 3000);
         });
    } else {
        console.log('User not logged in. Redirecting...');
        window.location.href = 'index.html'; // Redirect to login
    }
});
// ==========================================================
// End Admin Guard
// ==========================================================


// ==========================================================
// Main App Logic (Wrapped in Function)
// ==========================================================
function initializeAppLogic() {

    const monthsRef = database.ref('months');
    const lecturesRef = database.ref('lecturess'); // Correct path as per rules

    const yearSelector = document.getElementById('year-selector');
    const monthsContainer = document.getElementById('months-container');
    const uncategorizedContainer = document.getElementById('uncategorized-lectures');
    const alertMessageDiv = document.getElementById('alert-message'); // Defined again for clarity within scope

    let currentYearKey = null;
    let allMonthsData = {}; // Stores { id: ..., name: ..., order: ... }
    let allLecturesData = {}; // Stores raw data from lecturesRef/{year}

    // Populate year selector
    // Clear existing options first (except placeholder)
    yearSelector.innerHTML = '<option value="" disabled selected>--- اختر ---</option>';
    for (let i = 1; i <= 25; i++) {
        const teacherName = `مدرس ${i}`;
        const option = document.createElement('option');
        option.value = teacherName; // This is the key used in Firebase paths
        option.textContent = teacherName;
        yearSelector.appendChild(option);
    }

    // Function to show alerts within the app context
    function showAlert(message, type = 'success') {
         showGlobalAlert(message, type); // Use the global alert function
    }


    async function fetchDataAndRender() {
        currentYearKey = yearSelector.value;
        if (!currentYearKey) return;

        // Show loading states
        monthsContainer.innerHTML = `<div class="empty-state"><span class="loading-spinner"></span> جاري تحميل الشهور...</div>`;
        uncategorizedContainer.innerHTML = `<div class="empty-state"><span class="loading-spinner"></span></div>`;
        alertMessageDiv.innerHTML = ''; // Clear previous alerts

        try {
            // Fetch months for the selected year
            const monthSnapshot = await monthsRef.child(currentYearKey).once('value');
            const rawMonths = monthSnapshot.val() || {};

            // Fetch all lectures for the selected year
            const lectureSnapshot = await lecturesRef.child(currentYearKey).once('value');
            allLecturesData = lectureSnapshot.val() || {}; // Store raw lecture data

            // Prepare sorted months array
            allMonthsData = Object.entries(rawMonths).map(([id, data]) => ({ id, ...data }));
            allMonthsData.sort((a, b) => (a.order || 999) - (b.order || 999)); // Sort by order

            renderUI();

        } catch (error) {
            console.error("Error fetching data:", error);
            showAlert(`🚫 فشل تحميل البيانات: ${error.message}. تأكد من قواعد الأمان.`, 'danger');
            monthsContainer.innerHTML = `<div class="empty-state" style="color: var(--danger-color);">فشل تحميل الشهور.</div>`;
             uncategorizedContainer.innerHTML = `<div class="empty-state" style="color: var(--danger-color);">فشل تحميل المحاضرات.</div>`;
        }
    }

    function renderUI() {
        // --- Render Month Columns ---
        if (allMonthsData.length === 0) {
            monthsContainer.innerHTML = `<div class="empty-state">لا توجد شهور مُضافة لهذا المدرس/السنة.</div>`;
        } else {
            monthsContainer.innerHTML = allMonthsData.map(month => `
                <div class="month-column" data-month-id="${month.id}">
                    <div class="panel-title">${month.name || `شهر (${month.id})`}</div>
                    <div id="month-${month.id}-lectures">
                         <div class="empty-state">اسحب المحاضرات إلى هنا</div>
                    </div>
                </div>
            `).join('');
        }

        // --- Render Lectures ---
        uncategorizedContainer.innerHTML = ''; // Clear uncategorized first
        // Clear lecture divs inside month columns
        document.querySelectorAll('.month-column > div[id$="-lectures"]').forEach(div => div.innerHTML = '');


        let hasUncategorizedLectures = false;
        let lecturesRenderedCount = 0;

        // Iterate through the raw lecture data for the current year
        Object.entries(allLecturesData).forEach(([key, value]) => {
            // Check if 'value' looks like a lecture object (has a 'title')
            // or if 'key' is a known month ID (meaning 'value' is an object of lectures)
            const isMonthNode = allMonthsData.some(m => m.id === key);

            if (isMonthNode && typeof value === 'object' && value !== null) {
                // This key is a month ID, and value is an object containing lectures for that month
                const monthId = key;
                const lecturesInMonth = value;
                const container = document.getElementById(`month-${monthId}-lectures`);
                if (container) {
                    container.innerHTML = ''; // Clear placeholder
                    let lecturesAddedToMonth = false;
                    Object.entries(lecturesInMonth).forEach(([lectureId, lectureData]) => {
                         if (lectureData && lectureData.title) { // Check if it's a valid lecture
                            container.innerHTML += createLectureItem(lectureId, lectureData, monthId);
                            lecturesAddedToMonth = true;
                             lecturesRenderedCount++;
                         }
                    });
                     // If no valid lectures were added, show empty state for the month
                    if (!lecturesAddedToMonth) {
                         container.innerHTML = '<div class="empty-state">اسحب المحاضرات إلى هنا</div>';
                    }
                }
            } else if (value && value.title && !isMonthNode) {
                 // This key is likely a lecture ID directly under the year (uncategorized)
                 // And the value looks like a lecture object
                const lectureId = key;
                const lectureData = value;
                 // Add to the uncategorized container
                uncategorizedContainer.innerHTML += createLectureItem(lectureId, lectureData, '_uncategorized_');
                hasUncategorizedLectures = true;
                 lecturesRenderedCount++;
            }
             // else: Ignore keys that are neither month IDs nor valid lecture objects
        });


        // Set empty state for uncategorized if no lectures were added
        if (!hasUncategorizedLectures) {
            uncategorizedContainer.innerHTML = `<div class="empty-state">لا توجد محاضرات غير مصنفة.</div>`;
        }
         // Set empty state for months container if no months AND no uncategorized lectures exist
         if (allMonthsData.length === 0 && !hasUncategorizedLectures && lecturesRenderedCount === 0) {
              monthsContainer.innerHTML = `<div class="empty-state">لا توجد شهور أو محاضرات لعرضها لهذه السنة/المدرس.</div>`;
         }


        // --- Add Drag-Drop Listeners ---
        // Add to lecture items
         document.querySelectorAll('.lecture-item').forEach(item => {
             item.addEventListener('dragstart', handleDragStart);
             item.addEventListener('dragend', handleDragEnd);
         });
        // Add to all columns (months + uncategorized)
        document.querySelectorAll('.month-column').forEach(column => {
            column.addEventListener('dragover', handleDragOver);
            column.addEventListener('dragleave', handleDragLeave);
            column.addEventListener('drop', handleDrop);
        });
    }


    function createLectureItem(id, data, parentMonthId) {
         // Ensure data exists and has a title
         if (!data || typeof data.title === 'undefined') {
             console.warn(`Skipping lecture item creation for ID ${id}: Invalid data.`);
             return ''; // Return empty string if data is invalid
         }
        return `
        <div class="lecture-item"
             draggable="true"
             data-lecture-id="${id}"
             data-current-month-id="${parentMonthId}"
             data-lecture-title="${data.title || 'محاضرة بدون عنوان'}">
            ${data.lectureNumber ? data.lectureNumber + '.' : ''} ${data.title || 'محاضرة بدون عنوان'}
        </div>
        `;
    }

    // ==========================================================
    // Drag and Drop Logic
    // ==========================================================
    let draggedLecture = null; // Store the element being dragged

     function handleDragStart(e) {
         // Check if the dragged element is indeed a lecture item
         if (e.target.classList.contains('lecture-item')) {
             draggedLecture = e.target;
             // Set data to be transferred (lecture ID is useful)
             e.dataTransfer.setData('text/plain', e.target.dataset.lectureId);
             e.dataTransfer.effectAllowed = 'move'; // Indicate the type of operation
             // Add styling to the dragged item (slight delay for visual effect)
             setTimeout(() => e.target.classList.add('is-dragging'), 0);
         } else {
             e.preventDefault(); // Prevent dragging unintended elements
         }
     }

     function handleDragEnd(e) {
         // Clean up styles when dragging finishes (whether dropped successfully or cancelled)
         if (draggedLecture) {
             draggedLecture.classList.remove('is-dragging');
         }
         draggedLecture = null; // Clear the reference
          // Remove drag-over class from all columns just in case
          document.querySelectorAll('.month-column.drag-over').forEach(col => col.classList.remove('drag-over'));
     }

    function handleDragOver(e) {
        e.preventDefault(); // Necessary to allow dropping
        e.dataTransfer.dropEffect = 'move'; // Visual feedback to the user

        const dropTargetColumn = e.target.closest('.month-column');
        // Add highlight only to the potential drop target
        if (dropTargetColumn && dropTargetColumn !== draggedLecture.parentElement) {
             // Remove from others first
             document.querySelectorAll('.month-column.drag-over').forEach(col => col.classList.remove('drag-over'));
            dropTargetColumn.classList.add('drag-over');
        }
    }

    function handleDragLeave(e) {
         // Remove highlight if dragging leaves the column area
        const dropTargetColumn = e.target.closest('.month-column');
        if (dropTargetColumn) {
            // Check if the related target (where the mouse moved to) is outside the column
             if (!dropTargetColumn.contains(e.relatedTarget)) {
                dropTargetColumn.classList.remove('drag-over');
             }
        } else {
             // If leaving the window or other elements, clear all highlights
             document.querySelectorAll('.month-column.drag-over').forEach(col => col.classList.remove('drag-over'));
        }
    }


    async function handleDrop(e) {
        e.preventDefault(); // Prevent default browser action
        const dropTargetColumn = e.target.closest('.month-column');

        // Ensure drop is on a valid column and an item was being dragged
        if (!dropTargetColumn || !draggedLecture) {
             if (draggedLecture) draggedLecture.classList.remove('is-dragging'); // Clean up style if drop failed
             draggedLecture = null;
            return;
        }

        dropTargetColumn.classList.remove('drag-over'); // Remove highlight

        // Get data from dragged item and drop target
        const newMonthId = dropTargetColumn.dataset.monthId;
        const lectureId = draggedLecture.dataset.lectureId;
        const oldMonthId = draggedLecture.dataset.currentMonthId;
        const lectureTitle = draggedLecture.dataset.lectureTitle;

        // Don't do anything if dropped in the same column
        if (oldMonthId === newMonthId) {
             draggedLecture.classList.remove('is-dragging'); // Still need to remove class
             draggedLecture = null;
            return;
        }


        // --- Optimistic UI Update ---
        // Find the correct container within the drop target column
        let targetLectureContainer = dropTargetColumn.querySelector('div[id$="-lectures"]');
         // If dropping in uncategorized, the container IS the column itself
         if (newMonthId === '_uncategorized_') {
             targetLectureContainer = dropTargetColumn;
         }
        // Remove empty state if it exists
         const emptyState = targetLectureContainer.querySelector('.empty-state');
         if (emptyState) {
             targetLectureContainer.removeChild(emptyState);
         }
        // Append the dragged item
        targetLectureContainer.appendChild(draggedLecture);
        // Update the item's data attribute for future drags from this new location
        draggedLecture.dataset.currentMonthId = newMonthId;
         // Add empty state back to old container if it's now empty
         const oldContainer = document.querySelector(`[data-month-id="${oldMonthId}"]`).querySelector('div[id$="-lectures"]') || document.querySelector(`[data-month-id="${oldMonthId}"]`);
         if (oldContainer && !oldContainer.querySelector('.lecture-item')) {
             const emptyText = oldMonthId === '_uncategorized_' ? 'لا توجد محاضرات غير مصنفة.' : 'اسحب المحاضرات إلى هنا';
             oldContainer.innerHTML = `<div class="empty-state">${emptyText}</div>`;
         }
        // --- End Optimistic UI Update ---

        // Clear dragged item reference *after* moving it
        const tempDragged = draggedLecture; // Keep reference for cleanup
        draggedLecture = null;
        if (tempDragged) tempDragged.classList.remove('is-dragging');


        // --- Update Firebase ---
        await updateLectureLocation(lectureId, oldMonthId, newMonthId, lectureTitle);
    }


    async function updateLectureLocation(lectureId, oldMonthId, newMonthId, lectureTitle) {
        if (!currentYearKey || !lectureId) return;

        // Determine the old and new paths in the database
        const oldPath = (oldMonthId === '_uncategorized_')
            ? `lecturess/${currentYearKey}/${lectureId}` // Directly under year
            : `lecturess/${currentYearKey}/${oldMonthId}/${lectureId}`; // Under the specific month

        const newPath = (newMonthId === '_uncategorized_')
            ? `lecturess/${currentYearKey}/${lectureId}` // Directly under year
            : `lecturess/${currentYearKey}/${newMonthId}/${lectureId}`; // Under the specific month

        showAlert(`⏳ جاري نقل "${lectureTitle}"...`, 'success'); // Using success style for processing

        try {
            // 1. Get the current lecture data from the old path
            const snapshot = await database.ref(oldPath).once('value');
            const lectureData = snapshot.val();

            if (!lectureData) {
                throw new Error(`لم يتم العثور على بيانات المحاضرة الأصلية في المسار: ${oldPath}`);
            }

            // 2. Update the 'month' property within the lecture data (important for consistency)
            lectureData.month = newMonthId; // Assign the new month ID or '_uncategorized_'

            // 3. Prepare the atomic update
            const updates = {};
            updates[newPath] = lectureData; // Write data to the new path
            updates[oldPath] = null;         // Delete data from the old path

            // 4. Execute the update
            await database.ref().update(updates);

            showAlert(`✅ تم نقل "${lectureTitle}" بنجاح!`, 'success');

            // 5. Update local state and re-render (important for consistency after Firebase update)
             // It might be safer to refetch, but updating local state is faster if confident
            // Remove from old location in local data
             if (oldMonthId === '_uncategorized_') {
                 delete allLecturesData[lectureId];
             } else {
                 if (allLecturesData[oldMonthId]) {
                     delete allLecturesData[oldMonthId][lectureId];
                     // If month becomes empty, remove month node locally? Or let refetch handle it.
                 }
             }
             // Add to new location in local data
              if (newMonthId === '_uncategorized_') {
                  allLecturesData[lectureId] = lectureData;
              } else {
                  if (!allLecturesData[newMonthId]) {
                     allLecturesData[newMonthId] = {}; // Create month node if it doesn't exist locally
                  }
                  allLecturesData[newMonthId][lectureId] = lectureData;
              }
            // Optional: Re-render UI based on updated local state instead of full refetch
            // renderUI(); // Or just let the next full fetch handle it if needed

        } catch (error) {
            console.error('Firebase Update Error:', error);
            showAlert(`🚫 فشل النقل: ${error.message}. سيتم إعادة تحميل الواجهة.`, 'danger');
            // Revert UI on failure by refetching data from Firebase
            setTimeout(fetchDataAndRender, 1500); // Delay slightly before refetching
        }
    }

    // --- Initial Setup ---
    yearSelector.addEventListener('change', fetchDataAndRender);

} // --- End of initializeAppLogic ---

</script>
</body>
</html>
